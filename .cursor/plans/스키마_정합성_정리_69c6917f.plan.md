---
name: 스키마 정합성 정리
overview: 기획 문서의 Firestore 스키마와 현재 코드의 18개 엔티티/모델 간 차이를 분석하고, 누락 필드 추가 및 구조 정렬을 위한 수정 계획을 수립합니다.
todos:
  - id: phase1-match-entity
    content: Match 엔티티에 matchType, minPlayers, isTimeConfirmed, opponent 객체, createdBy, updatedAt 추가 + MatchStatus enum 확장 (pending, fixed, inProgress)
    status: pending
  - id: phase1-match-model
    content: MatchModel의 fromFirestore/toFirestore에 새 필드 직렬화 반영 + OpponentInfo 내장 클래스 모델
    status: pending
  - id: phase1-schema-update
    content: SCHEMA.md에 matches 컨렉션 업데이트 (matchType, minPlayers, isTimeConfirmed, opponent 객체, 새 status 값)
    status: pending
  - id: phase2-opponent
    content: Team 엔티티에 recentResults/records 추가 또는 별도 Opponent 엔티티 생성
    status: pending
  - id: phase3-minor-fields
    content: Member에 memo, Transaction에 date/category/memo/createdBy, Notification에 readBy/targetGroup 추가
    status: pending
  - id: phase4-attendance-auto
    content: 참석 투표 = 출석 자동화 로직 구현 (Event 종료 시 EventAttendee.status 자동 전환)
    status: pending
isProject: false
---

# 기획서 vs 현재 코드 스키마 정합성 분석 및 정렬 계획

## 현재 상태

- 코드: 18개 엔티티, 18개 모델, 20개 enum
- 스키마 문서: [SCHEMA.md](SCHEMA.md) (v4.0, 2025-01-18)
- 코드와 SCHEMA.md는 대체로 일치하지만, **기획 문서에서 요구하는 필드/로직이 둘 다에 반영되지 않은 부분**이 존재

---

## GAP 분석: 컬렉션별 비교

### 1. matches (차이 큼 - 최우선)

**현재 코드** ([lib/features/matches/domain/entities/match.dart](lib/features/matches/domain/entities/match.dart)):

```dart
// 현재 필드
matchId, teamName, date, startTime, endTime, location,
status, gameStatus, recruitStatus, registerStart, registerEnd,
participants, attendees, absentees, createdAt
```

**기획서에서 요구하지만 없는 필드:**


| 누락 필드             | 타입                                  | 용도          | 우선순위 |
| ----------------- | ----------------------------------- | ----------- | ---- |
| `matchType`       | String (regular/irregular)          | 정기/비정기 구분   | 높음   |
| `minPlayers`      | int (기본값 7)                         | 경기 성사 최소 인원 | 높음   |
| `isTimeConfirmed` | bool                                | 시간 확정 여부    | 높음   |
| `opponent`        | Map (teamId, name, contact, status) | 상대팀 정보 객체   | 높음   |
| `createdBy`       | String                              | 등록자 UID     | 중간   |
| `updatedAt`       | DateTime                            | 최종 수정 시각    | 중간   |


**MatchStatus enum 변경 필요:**

```
현재: draft, confirmed, finished, cancelled
기획: pending, confirmed, fixed, inProgress, ended, canceled
```

- `draft` -> `pending` (의미 일치, 네이밍 통일)
- `fixed` 추가 (인원 충족으로 자동 성사)
- `inProgress` 추가 (경기 진행 중)
- `finished` -> `ended` (네이밍 통일, 선택적)

`**teamName` -> `opponent` 구조 변경:**

- 현재 `teamName`은 단순 문자열로 상대팀 이름만 저장
- 기획서는 `opponent` 객체 (`{ teamId, name, contact, status: "seeking"|"confirmed" }`) 필요
- `opponents` 컬렉션의 문서와 연결되어야 함

`**recruitStatus` 제거 가능:**

- `opponent.status`로 대체 가능 (seeking = pending, confirmed = confirmed)

---

### 2. teams / opponents (구조 혼재)

**현재 코드** ([lib/features/teams/domain/entities/team.dart](lib/features/teams/domain/entities/team.dart)):

- `isOurTeam` 필드로 우리 팀과 상대팀을 하나의 엔티티로 관리

**기획서 요구:**

- `teams/{teamId}` = 우리 팀 (팀 설정/코어 데이터)
- `teams/{teamId}/opponents/{opponentId}` = 상대팀 (별도 서브컬렉션)
- 상대팀에 `recentResults`, `records` (wins/draws/losses) 필드 필요

**필요한 조치:**

- `Opponent` 엔티티/모델 신규 생성 또는 기존 `Team` 엔티티에 `recentResults`, `records` 필드 추가
- `isOurTeam`으로 구분하는 현재 방식은 유지하되, Firestore 경로를 `opponents/` 서브컬렉션으로 분리

---

### 3. members (차이 작음)

**현재 코드** ([lib/features/teams/domain/entities/member.dart](lib/features/teams/domain/entities/member.dart)):

- 기획서와 거의 일치
- `MemberStatus`: active, pending, rejected, left

**누락 필드:**


| 누락 필드  | 타입     | 용도     |
| ------ | ------ | ------ |
| `memo` | String | 관리자 메모 |


**role/department enum 미정의:**

- 현재 `role`은 String 타입 (enum 아님)
- 기획서 role 값: "일반회원", "운영진", "총무", "팀장"
- 기획서 department 값: "경기관리/대외협력팀", "수업관리팀", "운영팀", "미정"
- enum으로 만들지 String으로 유지할지 결정 필요 (유연성 위해 String 유지 권장)

---

### 4. transactions (차이 중간)

**현재 코드** ([lib/features/transactions/domain/entities/transaction.dart](lib/features/transactions/domain/entities/transaction.dart)):

```dart
transactionId, type, amount, userId, description, status, createdAt, completedAt
```

**기획서 요구 vs 현재:**


| 누락 필드       | 타입       | 용도                    |
| ----------- | -------- | --------------------- |
| `date`      | DateTime | 거래 날짜 (createdAt과 별도) |
| `category`  | String   | 분류 (수강료, 회비, 구장비 등)   |
| `memo`      | String   | 메모                    |
| `createdBy` | String   | 등록자                   |


**TransactionType 확장 필요:**

- 현재: payment, refund, fee
- 기획서: income(입금), expense(출금) 구분 추가 필요

---

### 5. notifications (차이 중간)

**현재 코드** ([lib/features/notifications/domain/entities/notification.dart](lib/features/notifications/domain/entities/notification.dart)):

```dart
notificationId, title, message, type, relatedId, toUserId, isSent, sendAt, createdAt
```

**누락 필드:**


| 누락 필드         | 타입             | 용도                                |
| ------------- | -------------- | --------------------------------- |
| `readBy`      | List of String | 읽은 사용자 추적                         |
| `targetGroup` | String         | 발송 대상 그룹 (allMembers, managers 등) |


---

### 6. events (차이 작음 - 잘 정렬됨)

- 현재 코드가 SCHEMA.md와 잘 일치
- `AttendanceSummary`, `EventAttendee`, `EventComment` 내장 구조 이미 존재
- **출석 자동화**: "참석 투표 = 출석"이므로, `EventAttendee.status`가 `attending`이면 이벤트 종료 후 자동으로 `attended`로 전환하는 로직만 추가하면 됨

---

### 7. 코드에 없는 컬렉션 (기획서에만 존재)


| 컬렉션             | 용도                         | 우선순위 |
| --------------- | -------------------------- | ---- |
| `documents`     | 공식 문서 (회칙, 계약서) 관리         | 낮음   |
| `users_private` | 사용자별 lastTeamId, fcmTokens | 중간   |


---

### 8. 나머지 (차이 없음 또는 미미)

- **polls**: 잘 정렬됨
- **posts**: 잘 정렬됨
- **grounds**: 잘 정렬됨
- **registrations**: 잘 정렬됨
- **reservations**: 잘 정렬됨
- **fees**: 잘 정렬됨
- **feedbacks**: 잘 정렬됨
- **match_media**: 잘 정렬됨
- **settings**: 잘 정렬됨

---

## 수정 우선순위 및 실행 순서

### Phase 1: Match 스키마 정렬 (가장 급함)

경기 성사 로직 고도화의 전제 조건이므로 먼저 수행:

1. `Match` 엔티티에 `matchType`, `minPlayers`, `isTimeConfirmed`, `opponent` 객체, `createdBy`, `updatedAt` 추가
2. `MatchStatus` enum 확장 (`pending`, `fixed`, `inProgress` 추가)
3. `Opponent` 내장 클래스 생성 (`OpponentInfo { teamId, name, contact, status }`)
4. `MatchModel` 직렬화 업데이트
5. `recruitStatus` 필드는 `opponent.status`로 대체 (점진적 폐기)
6. SCHEMA.md 업데이트

### Phase 2: Team/Opponent 분리

1. `Team` 엔티티에 `recentResults`, `records` 필드 추가 (상대팀용)
2. 또는 별도 `Opponent` 엔티티 신규 생성
3. `MatchRemoteDataSource`에서 opponents 서브컬렉션 쿼리 지원

### Phase 3: 기타 누락 필드 보완

1. `Member`에 `memo` 추가
2. `Transaction`에 `date`, `category`, `memo`, `createdBy` 추가
3. `Notification`에 `readBy`, `targetGroup` 추가

### Phase 4: 출석 자동화 연결

1. `Event`의 참석 투표 데이터를 이벤트 종료 시 자동 출석으로 전환하는 로직 추가
2. `RegistrationStatus`의 `attended`/`absent` 자동 설정

---

## 영향 범위

Phase 1에서 수정하는 파일:

- `lib/features/matches/domain/entities/match.dart` (엔티티 + enum)
- `lib/features/matches/data/models/match_model.dart` (직렬화)
- `lib/features/matches/data/datasources/match_remote_data_source.dart` (쿼리/업데이트)
- `lib/features/matches/presentation/providers/match_providers.dart` (프로바이더)
- `lib/features/matches/presentation/pages/home_page.dart` (UI 반영)
- `SCHEMA.md` (문서 동기화)

