import 'package:flutter/material.dart';
import 'package:cloud_firestore/cloud_firestore.dart';
import 'package:provider/provider.dart';
import 'package:intl/intl.dart';

import '../../providers/user_role_provider.dart';

class MatchAddPage extends StatefulWidget {
  final String teamId;

  const MatchAddPage({super.key, required this.teamId});

  @override
  State<MatchAddPage> createState() => _MatchAddPageState();
}

class _MatchAddPageState extends State<MatchAddPage> {
  late final TextEditingController _teamNameController;
  late final TextEditingController _locationController;
  late final TextEditingController _startTimeController;
  late final TextEditingController _endTimeController;

  DateTime? _selectedDate;
  DateTime? _registerStart;
  DateTime? _registerEnd;

  @override
  void initState() {
    super.initState();
    _teamNameController = TextEditingController();
    _locationController = TextEditingController();
    _startTimeController = TextEditingController();
    _endTimeController = TextEditingController();
  }

  @override
  void dispose() {
    _teamNameController.dispose();
    _locationController.dispose();
    _startTimeController.dispose();
    _endTimeController.dispose();
    super.dispose();
  }

  Future<void> _pickDate(
    BuildContext context,
    void Function(DateTime) onPicked,
  ) async {
    final picked = await showDatePicker(
      context: context,
      initialDate: DateTime.now(),
      firstDate: DateTime(2020),
      lastDate: DateTime(2030),
    );
    if (picked != null) {
      setState(() => onPicked(picked));
    }
  }

  Future<void> _saveMatch() async {
    if (_teamNameController.text.isEmpty ||
        _locationController.text.isEmpty ||
        _startTimeController.text.isEmpty ||
        _endTimeController.text.isEmpty ||
        _selectedDate == null ||
        _registerStart == null ||
        _registerEnd == null) {
      ScaffoldMessenger.of(
        context,
      ).showSnackBar(const SnackBar(content: Text('Î™®Îì† ÌïÑÎìúÎ•º ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî')));
      return;
    }

    await FirebaseFirestore.instance
        .collection('teams')
        .doc(widget.teamId)
        .collection('matches')
        .add({
          'teamName': _teamNameController.text.trim(),
          'location': _locationController.text.trim(),
          'startTime': _startTimeController.text.trim(),
          'endTime': _endTimeController.text.trim(),
          'date': Timestamp.fromDate(_selectedDate!),
          'registerStart': Timestamp.fromDate(_registerStart!),
          'registerEnd': Timestamp.fromDate(_registerEnd!),
          'recruitStatus': 'confirmed',
          'createdAt': FieldValue.serverTimestamp(),
          'teamId': widget.teamId,
        });

    if (mounted) {
      Navigator.pop(context);
      ScaffoldMessenger.of(
        context,
      ).showSnackBar(const SnackBar(content: Text('‚úÖ Îß§ÏπòÍ∞Ä Îì±Î°ùÎêòÏóàÏäµÎãàÎã§.')));
    }
  }

  @override
  Widget build(BuildContext context) {
    final role = context.watch<UserRoleProvider>().role;
    final isMatchManager = role == 'Í≤ΩÍ∏∞ÌåÄ';

    if (!isMatchManager) {
      return const Scaffold(
        body: Center(child: Text('‚ö†Ô∏è Í≤ΩÍ∏∞ÌåÄÎßå Îß§ÏπòÎ•º Îì±Î°ùÌï† Ïàò ÏûàÏäµÎãàÎã§')),
      );
    }

    final dateFormat = DateFormat('yyyy-MM-dd');

    return Scaffold(
      appBar: AppBar(title: const Text('‚ûï Îß§Ïπò Îì±Î°ù')),
      body: SingleChildScrollView(
        padding: const EdgeInsets.all(16),
        child: Column(
          children: [
            TextField(
              controller: _teamNameController,
              decoration: const InputDecoration(
                labelText: 'ÏÉÅÎåÄÌåÄ Ïù¥Î¶Ñ',
                prefixIcon: Icon(Icons.sports_soccer),
              ),
            ),
            const SizedBox(height: 12),
            TextField(
              controller: _locationController,
              decoration: const InputDecoration(
                labelText: 'Ïû•ÏÜå',
                prefixIcon: Icon(Icons.place),
              ),
            ),
            const SizedBox(height: 12),
            TextField(
              controller: _startTimeController,
              decoration: const InputDecoration(
                labelText: 'ÏãúÏûë ÏãúÍ∞Ñ (Ïòà: 18:00)',
                prefixIcon: Icon(Icons.schedule),
              ),
            ),
            const SizedBox(height: 12),
            TextField(
              controller: _endTimeController,
              decoration: const InputDecoration(
                labelText: 'Ï¢ÖÎ£å ÏãúÍ∞Ñ (Ïòà: 20:00)',
                prefixIcon: Icon(Icons.schedule),
              ),
            ),
            const SizedBox(height: 16),
            Row(
              children: [
                Expanded(
                  child: Text(
                    _selectedDate == null
                        ? 'üìÖ Îß§Ïπò ÎÇ†Ïßú ÏÑ†ÌÉù ÏïàÎê®'
                        : 'Îß§Ïπò ÎÇ†Ïßú: ${dateFormat.format(_selectedDate!)}',
                  ),
                ),
                TextButton(
                  onPressed: () =>
                      _pickDate(context, (picked) => _selectedDate = picked),
                  child: const Text('Îß§Ïπò ÎÇ†Ïßú ÏÑ†ÌÉù'),
                ),
              ],
            ),
            Row(
              children: [
                Expanded(
                  child: Text(
                    _registerStart == null
                        ? 'üìÖ Îì±Î°ù ÏãúÏûëÏùº ÏÑ†ÌÉù ÏïàÎê®'
                        : 'Îì±Î°ù ÏãúÏûë: ${dateFormat.format(_registerStart!)}',
                  ),
                ),
                TextButton(
                  onPressed: () =>
                      _pickDate(context, (picked) => _registerStart = picked),
                  child: const Text('Îì±Î°ù ÏãúÏûëÏùº'),
                ),
              ],
            ),
            Row(
              children: [
                Expanded(
                  child: Text(
                    _registerEnd == null
                        ? 'üìÖ Îì±Î°ù Ï¢ÖÎ£åÏùº ÏÑ†ÌÉù ÏïàÎê®'
                        : 'Îì±Î°ù Ï¢ÖÎ£å: ${dateFormat.format(_registerEnd!)}',
                  ),
                ),
                TextButton(
                  onPressed: () =>
                      _pickDate(context, (picked) => _registerEnd = picked),
                  child: const Text('Îì±Î°ù Ï¢ÖÎ£åÏùº'),
                ),
              ],
            ),
            const SizedBox(height: 24),
            SizedBox(
              width: double.infinity,
              child: ElevatedButton.icon(
                icon: const Icon(Icons.save),
                label: const Text('‚úÖ Ï†ÄÏû•'),
                onPressed: _saveMatch,
              ),
            ),
          ],
        ),
      ),
    );
  }
}
