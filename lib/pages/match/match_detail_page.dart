import 'package:flutter/material.dart';
import 'package:cloud_firestore/cloud_firestore.dart';
import '../../models/match_event_model.dart';
import 'widgets/round_selector.dart';
import 'widgets/record_buttons.dart';
import 'widgets/record_modals.dart';
import 'widgets/record_list.dart';
import 'widgets/team_select_button.dart';
import '../../services/firestore/match_service.dart';

class MatchDetailPage extends StatefulWidget {
  final MatchEvent event;
  const MatchDetailPage({super.key, required this.event});

  @override
  State<MatchDetailPage> createState() => _MatchDetailPageState();
}

class _MatchDetailPageState extends State<MatchDetailPage> {
  String? selectedRoundId;

  @override
  Widget build(BuildContext context) {
    return Scaffold(
      appBar: AppBar(title: Text('üìã ${widget.event.teamName}')),
      body: StreamBuilder<DocumentSnapshot>(
        stream: FirebaseFirestore.instance
            .collection('matches')
            .doc(widget.event.id)
            .snapshots(),
        builder: (context, snap) {
          if (!snap.hasData) {
            return const Center(child: CircularProgressIndicator());
          }

          final data = snap.data!.data() as Map<String, dynamic>;
          final participants = (data['participants'] ?? []) as List;
          final recruitStatus = data['recruitStatus'] ?? 'waiting';

          return Column(
            crossAxisAlignment: CrossAxisAlignment.start,
            children: [
              // ÏÉÅÎã® Ï†ïÎ≥¥
              Padding(
                padding: const EdgeInsets.all(16),
                child: Column(
                  crossAxisAlignment: CrossAxisAlignment.start,
                  children: [
                    Text('Î™®Ïßë ÏÉÅÌÉú: $recruitStatus'),
                    Text('Ï∞∏ÏÑùÏûê Ïàò: ${participants.length} Î™Ö'),
                    const SizedBox(height: 8),
                    TeamSelectButton(matchId: widget.event.id),
                  ],
                ),
              ),
              const Divider(height: 1),

              // ÎùºÏö¥Îìú ÏÑ†ÌÉù
              RoundSelector(
                matchId: widget.event.id,
                onSelected: (roundId) {
                  setState(() => selectedRoundId = roundId);
                },
              ),

              // ÎùºÏö¥ÎìúÎ≥Ñ Í∏∞Î°ù Í¥ÄÎ¶¨
              if (selectedRoundId != null) ...[
                // ÎùºÏö¥Îìú ÏÉÅÌÉú Í¥ÄÎ¶¨ Î≤ÑÌäº
                Padding(
                  padding: const EdgeInsets.symmetric(
                    horizontal: 16,
                    vertical: 8,
                  ),
                  child: StreamBuilder<DocumentSnapshot>(
                    stream: FirebaseFirestore.instance
                        .collection('matches')
                        .doc(widget.event.id)
                        .collection('rounds')
                        .doc(selectedRoundId!)
                        .snapshots(),
                    builder: (context, roundSnap) {
                      if (!roundSnap.hasData || !roundSnap.data!.exists) {
                        return const SizedBox();
                      }
                      final roundData =
                          roundSnap.data!.data() as Map<String, dynamic>;
                      final status = roundData['status'] ?? 'notStarted';

                      return Row(
                        children: [
                          ElevatedButton.icon(
                            icon: const Icon(Icons.play_arrow),
                            label: const Text('ÎùºÏö¥Îìú ÏãúÏûë'),
                            onPressed: status == 'notStarted'
                                ? () async {
                                    await MatchService.updateRoundStatus(
                                      widget.event.id,
                                      selectedRoundId!,
                                      'inProgress',
                                    );
                                    await FirebaseFirestore.instance
                                        .collection('matches')
                                        .doc(widget.event.id)
                                        .collection('rounds')
                                        .doc(selectedRoundId!)
                                        .update({'startTime': Timestamp.now()});
                                  }
                                : null,
                          ),
                          const SizedBox(width: 12),
                          ElevatedButton.icon(
                            icon: const Icon(Icons.stop),
                            label: const Text('ÎùºÏö¥Îìú Ï¢ÖÎ£å'),
                            onPressed: status == 'inProgress'
                                ? () async {
                                    await MatchService.updateRoundStatus(
                                      widget.event.id,
                                      selectedRoundId!,
                                      'finished',
                                    );
                                    await FirebaseFirestore.instance
                                        .collection('matches')
                                        .doc(widget.event.id)
                                        .collection('rounds')
                                        .doc(selectedRoundId!)
                                        .update({'endTime': Timestamp.now()});
                                  }
                                : null,
                          ),
                          const SizedBox(width: 12),
                          Text('ÏÉÅÌÉú: $status'),
                        ],
                      );
                    },
                  ),
                ),

                // ÎìùÏ†ê/ÍµêÏ≤¥ Í∏∞Î°ù Î≤ÑÌäº
                RecordButtons(
                  onAddGoal: () {
                    showRecordGoalModal(
                      context,
                      widget.event.id,
                      selectedRoundId!,
                    );
                  },
                  onAddChange: () {
                    showRecordChangeModal(
                      context,
                      widget.event.id,
                      selectedRoundId!,
                    );
                  },
                ),

                // Í∏∞Î°ù Î¶¨Ïä§Ìä∏
                Expanded(
                  child: RecordList(
                    matchId: widget.event.id,
                    roundId: selectedRoundId!,
                  ),
                ),
              ],
            ],
          );
        },
      ),
    );
  }
}
